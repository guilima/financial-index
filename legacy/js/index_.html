<!DOCTYPE html>
<html>
<head>
	<title>Financial Index</title>
	<script>
		function getValue(codeId, date) {
			return new Promise(function (resolve, reject) {
			    var data = `<?xml version="1.0" encoding="utf-8"?>
			        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:soapdadasv="http://schemas.xmlsoap.org/soap/envelope/">
			        <soapdadasv:Body>
			            <getValor xmlns="https://www3.bcb.godadasv.br/wssgs/services/FachadaWSSGS">                  
			                <codigoSerie>${codeId}</codigoSerie>
			                <data>${date}</data>
			            </getValor>
			        </soapdadasv:Body>
			    </soapenv:Envelope>`;

			    var xhr = new XMLHttpRequest();
			    xhr.open('POST', 'https://www3.bcb.gov.br/wssgs/services/FachadaWSSGS?method=getValor');
			    xhr.setRequestHeader('content-type', 'application/xml');
			    xhr.setRequestHeader('soapaction', 'https://www3.bcb.gov.br/wssgs/services/FachadaWSSGS/getValor');
			    xhr.withCredentials = false;

		     	xhr.onload = function () {
		      		if (this.status >= 200 && this.status < 300) {
		        		resolve(xhr.responseXML);
		      		} else {
	        			reject({
							status: this.status,
							statusText: xhr.statusText
	        			});
		      		}
			    };
			    xhr.onerror = function () {
		      		reject({
		        		status: this.status,
	  		  			statusText: xhr.statusText
	      			});
			    };
			    xhr.send(data);
			});
		    // xhr.onload = function () {
		    //     console.log(xhr.response);
		    //     document.querySelector('h1').innerHTML += xhr.responseXML.querySelector('multiRef').innerHTML;
		    // };
		    // xhr.onerror = function () {
		    //     console.log(xhr);
		    // };		    
		};
		function generateDate(){
			var today = new Date(),
				currentMonth = today.getMonth()+1,
				currentYear = today.getFullYear(),
				dates = [];
				for(let month = 1; month < currentMonth; month++){
					if(month==1) {dates.push(`20/08/${currentYear-1}`);dates.push(`20/09/${currentYear-1}`);dates.push(`20/10/${currentYear-1}`);dates.push(`20/11/${currentYear-1}`); dates.push(`20/12/${currentYear-1}`)}
					dates.push(`20/${month}/${currentYear}`)
				}
				return dates;
		};
		Promise.all(generateDate().map(date=> getValue(4391, date)))
			.then(function (values) {
				values.forEach( (value, index) => {
					var numeric = Number(value.querySelector('multiRef').innerHTML);
					if(index) console.log(`${(numeric).toFixed(2)}%`);
				});
			})
			.catch(function (err) {
		  		console.error('Augh, there was an error!', err.statusText);
			});
		Promise.all(generateDate().map(date=> getValue(7845, date)))
			.then(function (values) {
				var a;
				var b;
				var c = Number(values[0].querySelector('multiRef').innerHTML);
				values.forEach( (value, index) => {
					var numeric = Number(value.querySelector('multiRef').innerHTML);
					a = c;
					b = (numeric * 100) / a;
					if(index) console.log(`${(b - 100).toFixed(2)}% (${numeric})`);
					c = numeric;
				});
			})
			.catch(function (err) {
		  		console.error('Augh, there was an error!', err.statusText);
			});
	</script>
</head>
<body>
	<h1>Hello World!</h1>
</body>
</html>