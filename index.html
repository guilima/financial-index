<html>
	<head>
		<title>Indíces de valores financiais</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link rel="stylesheet" href="styles.css">
	</head>
	<body>
		<section>
			<h1>Índices Financeiros</h1>
			<div>
				<table cellpadding="0" cellspacing="0" border="0">
					<thead class="tbl-header" id="tbl-header">
						<tr id="tbl-header-tr">
							<th></td>
						</tr>
					</thead>
					<tbody class="tbl-content" id="tbl-body">
						<tr id="tr-data"></tr>
					</tbody>
				</table>
			</div>
		</section>
		<script>
		function getValue() {
				return new Promise(function (resolve, reject) {
					var xhr = new XMLHttpRequest();
					xhr.open('GET', 'http://localhost:3000/users');
					xhr.setRequestHeader('content-type', 'application/json');
					xhr.withCredentials = false;

					xhr.onload = () => resolve(xhr.responseText);
					xhr.onerror = () => reject(xhr.statusText);

					xhr.send();
				});
			};
			getValue()
				.then(function (values) {
					console.log(JSON.parse(values));
					(function() {
						var res = JSON.parse(values);
						var c = Number(res[1]);
						function ibovespaPercentage(value, valueNext) {
							    value = Number(value),
								valueNext = typeof valueNext != 'undefined' ? Number(valueNext.valor) : c,
								b = ( - ( ( valueNext * 100 ) / value ) + 100 ).toFixed(2);
								console.log(valueNext);
								//console.log(`${b}% (${numeric})`);
								return `${b}% (${value})`;
						}
						res = res[0];
						//console.log(res);
						res.serie.forEach(serie => {
							var title = function() {
								switch (serie.ID) {
									case 4391: return 'CDI';
									case 433: return 'IPCA';
									case 189: return 'IGP-M';
									case 192: return 'INCC';
									case 7845: return 'Ibovespa';
									default: return 'Nulo';
								}
							};
							var thElem = document.createElement("th"); 
							var addTitle = document.createTextNode(title()); 
							thElem.appendChild(addTitle);
							var thRow = document.getElementById("tbl-header-tr");
							thRow.appendChild(thElem);
							//console.log(title());

							var trElem = document.createElement("tr");
							var tbody = document.getElementById("tbl-body");
							tbody.appendChild(trElem);
							serie.item.forEach( (item, index) => {
								if(serie.ID == 7845) {
									var t = ibovespaPercentage(item.valor, serie.item[index+1]);

									var tdDataElem = document.createElement("td"); 
									var trData = document.getElementById("tr-data");
									tdDataElem.appendChild(document.createTextNode(`${item.data}`));
									trData.appendChild(tdDataElem);
								} else {
									var t = `${item.valor}%`;
									//console.log(`${item.valor}%`);
								}
								var tdElem = document.createElement("td");
								var indexValue = document.createTextNode(t); 
								tdElem.appendChild(indexValue);
								trElem.appendChild(tdElem);
							});
						});
					})();
				})
				.catch(function (err) {
					console.error('Augh, there was an error!', err.statusText);
				});
		</script>
	</body>
</html>